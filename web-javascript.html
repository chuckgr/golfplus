<script>
/**
 * Contains all of the client side javascript to display the current leaderboard 
 */

/**
 * Request the data from the server 
 */
async function loadData() {
  const e = await new Promise(r => {
    google.script.run.withSuccessHandler(r).getData();
  });
  const results = updateTable(e);
}

/**
 * Update the table with the data from the spreadsheet
 * 
 * The css classes to color the 
 */
function updateTable(data) {
  let tableData = data.data;
  let courseData = data.courseData;

  const evenRowClasses = [
    ["s4", "s6", "s6", "s6", "s7r", "s6", "s6"], // below par - red
    ["s4", "s5", "s5", "s5", "s7b", "s5", "s5"]  // above par - black
    ]; // White
  const oddRowClasses =  [
    ["s8", "s10r", "s10r", "s10r", "s11", "s10r", "s10r"],  // there is no class for under par yet, so use above for now
    ["s8", "s10b", "s10b", "s10b", "s11", "s10b", "s10b"] 
    ]; // light yellow
  let bottomEvenRowClasses = [
    ["s13wr-r", "s13wr", "s13wr", "s13wr", "s15yb", "s6", "s6"], // red
    ["s13wb-r", "s13wb", "s13wb", "s13wb", "s15wb", "s5", "s5"] // black
  ]; // white
  let bottomOddRowClasses = [
    ["s2ybbb", "s13r", "s13r", "s13r", "s15yr", "s13r", "s13r"], // red
    ["s2ybbb", "s13b", "s13b", "s13b", "s15yb", "s13b",  "s13b"]  // black
  ]; // yellow
  let courseClasses = ["s16", "s5", "s5", "s5", "s7b", "s4", "s0"];
  const playerIds = [
    "playerName", "playerScore1", "playerScore2", "playerScore3", "playerScore4", "playerTotal", "playerScoreToPar"
  ];
  
  // Create the table for adding the data
  createTable();

  let row;
  let td;
  let parIndex = 1;
  let red = 0;
  let black = 1;
  let scoreToParCol = 6;
  let classSelect = black;
  let table = document.getElementById("lbbody");
  let limit = tableData.length;
  /**
   *  Loop for all of the table data and course data. add TD elements to TR elements
   */
  [...tableData, ...courseData].forEach((r,i) => {
    row = createTr();
    td = document.createElement('tr');
    td.classList.add('s0');
    row.appendChild(td);
    r.forEach((c,j) => {
      td = document.createElement('td');

      /**
       * Below we are still working on the player data rows
       */ 
      if (i < limit) {
        
        // Check the each player score to par to pick the correct class
        if ((j>0 && j<5) || j==scoreToParCol) {
          if (c>0) {
            parseInt(c) < parseInt(courseData[parIndex][j]) ? 
              classSelect = red : 
              classSelect = black;
          } else {
            classSelect = black;
          }
        }
        //if (j==scoreToParCol) { console.log(`${classSelect==0 ? "Red" : "Black"}`);}
        // Even/odd row TODO - pick class on under/over par
        if (i%2 == 0) {
          if (i==limit-1) {
            td.classList.add(bottomEvenRowClasses[classSelect][j]);
          } else {
            td.classList.add(evenRowClasses[classSelect][j]);
          }
        } else {
          if (i==limit-1) {
            td.classList.add(bottomOddRowClasses[classSelect][j]);
          } else {
            td.classList.add(oddRowClasses[classSelect][j]);
          }
        }
        td.id = playerIds[j];
        // Clear out the 0 scores...
        c==0 ? c="" : c=c;

        // Add parens for score to par
        j==scoreToParCol ? c=`(${c})` : c=c;


      /**
       * Above the limit, working on Course records now
       */
      } else {
        //console.log(`j=${j} class=${courseClasses[j]}`);
        td.classList.add(courseClasses[j]);
      }

      td.innerHTML = c;
      row.appendChild(td);
    });
    table.appendChild(row);
  });

}

/**
 * Create the table elements up to where the table contents (scores and course data)
 * 
 * @return {Element} Return the table element for the leaderboard table
 */
function createTable() {
  let thStyles = ["100px", "140px", "93px", "93px", "93px", "93px", "37px", "43px"];
  let table = document.createElement('table');
  table.id = "lbtable";
  table.classList.add("waffle");
  table.classList.add("no-grid");
  table.cellspacing = "0";
  table.cellpadding = "0";

  // Create the header elements
  let thead = document.createElement('thead');
  let tr = document.createElement('tr');
  let th = document.createElement('th');
  th.classList.add("row-headers-background");
  tr.appendChild(th);
  //let td;
  [...Array(8).keys()].forEach(i => {
    th = document.createElement('th');
    th.style.width = `${thStyles[i]}`;
    th.classList.add("s0");
    tr.appendChild(th);
  });
  thead.appendChild(tr);
  table.appendChild(thead);
  let tbody = document.createElement('tbody');
  tbody.id = "lbbody";

  tbody.appendChild(createBlankRow());
  tbody.appendChild(createTitle());
  tbody.appendChild(createHeader());
  table.appendChild(tbody);
  
  let tableDiv = document.getElementById("tableDiv");
  tableDiv.appendChild(table);
}

/**
 * Create a blank row in the table
 * 
 * @return {Element} Element to attach to the tbody
 */
function createBlankRow() {
  let tr = document.createElement('tr');
  tr.style.height = "20px";
  let th = createRowTh();
  let td;
  [...Array(8).keys()].forEach(i => {
    td = document.createElement('td');
    td.classList.add("s0");
    tr.appendChild(td);
  });
  return tr;
}

/**
 * Create the header row with the labels in it
 */
function createHeader() {
  let labels  = ["", "Name", "Round 1", "Round 2", "Round 3", "Round4", "Total", "+/-"];
  let classes = ["s0", "s2", "s3", "s3", "s3", "s3", "s3", "s3"];
  let tr = document.createElement('tr');
  tr.style.height = "20px";
  let th = createRowTh();
  tr.appendChild(th);
  // Add the labels
  [...Array(labels.length).keys()].forEach( (n,i) => {
    tr.appendChild(createHeaderTd(classes[n], labels[n]))
  });
  return tr;
}

/**
 * Create the header for the table
 * 
 * @return {Element} tr element with the header
 */
function createTitle() {
  let tr = document.createElement('tr');
  tr.style.height = "20px";
  let th = createRowTh();
  let td = document.createElement('td');
  td.classList.add("s0");
  th.appendChild(td);
  td = document.createElement('td');
  td.id = "tournyName";
  td.classList.add("s1");
  td.colspan = "7";
  td.innerHTML = "Generated Golf+ Leaderboard";
  th.appendChild(td);
  tr.appendChild(th);
  return tr;
}

/**
 * Function to add the labels for each column
 */
function createHeaderTd(headClass, label) {
  let td = document.createElement('td');
  if (headClass != "") {
    td.classList.add(headClass);
  }
  td.innerHTML = label;
  return td;
}

/**
 * Create the th for a table row (they are all the same...)
 */
function createRowTh() {
  console.log(`createRowTh`);
  let th = document.createElement('th');
  th.style.height = "20px";
  th.classList.add("row-header-background");
  let div = document.createElement('div');
  //div.style.line-height = "20px";
  div.classList.add("row-header-wrapper");
  th.appendChild(div);
  return th;
}

/**
 * Create the table row (tr) and header (th) components to add the table data (td) for 
 * each players scores.
 * 
 * @return {Element} Element to add the td as children to this table row.
 */
function createTr() {
  console.log(`createTr`);
  let tr = document.createElement('tr');
  tr.style.height = "20px";
  let th = document.createElement('th');
  th.classList.add("row-headers-background");
  th.style.height = "20px";
  let div = document.createElement('div');
  div.style.height = "20px";
  div.classList.add("row-header-wrapper");
  th.appendChild(div);
  tr.appendChild(th);
  return tr;
}

/**
 * Main
 */
loadData();



</script>
