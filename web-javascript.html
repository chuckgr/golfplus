<script>
/**
 * Contains all of the client side javascript to display the current leaderboard with the 
 * ability to see all previous leaderboards.  Will be adding the points leaderboard and a 
 * player stats page by selecting the players name on one of the leaderboards.
 * 
 * Copyright 2023 Chuck Grieshaber, All rights reserved.
 * Code can be used freely as long as the copyright statement is kept with 
 * all code used and the code is not used in a commercial product.
 */

/**
 * Classes start here
 */

/**
 * Tabe class that will create a new HTML table
 * 
 * @param {object} Options object to define the table. Object must contain the following entries
 *                 - name: Name of the table, name will also be used as a prefix for all ids associated with the table 
 *                 - cols: Number of columns for the the table
 *                 - colWidths: Array of css style widths for each column, one per column
 *                 - title: Title for the table
 *                 - labels: Array containing the labels for the columns
 *                 - classes: Array conrtaining the css styles for each columns
 * @param {array} Data for the body of the table. 2D array with each element having the me number of elements 
 *                as the numo of cols
 * @param {string} Element name to anchor this table to.
 */
class Table {
  constructor(options, data, anchor) {
    console.log(options);
    this._name = options.name;
    this._cols = options.cols;
    this._colWidths = options.colWidths;
    this._title = options.title;
    this._labels = options.labels;
    this._classes = options.classes;
    this._data = data;
    this._anchor = anchor;
    this._tableDivId = `${this._name}Div`;
    this._innerDivId = `${this._name}innerDiv`;
    this._bodyId = `${this._name}body`;
    /** Kick it off */
    this._createTable();
  }

  /**
   * Create the table element and pull in the rest
   */
  _createTable() {
    this._table = document.createElement('table');
    this._table.id = this._name;
    this._table.classList.add("waffle");
    this._table.classList.add("no-grid");
    this._table.cellSpacing = "0";
    this._table.cellPadding = "0";

    /** Create the header elements */
    let thead = document.createElement('thead');
    let tr = document.createElement('tr');
    let th = document.createElement('th');
    th.classList.add("row-headers-background");
    tr.appendChild(th);

    /** Rip through each column and add in the widths */
    [...Array(this._cols).keys()].forEach(i => {
      th = document.createElement('th');
      th.style.width = `${this._colWidths[i]}`;
      th.classList.add("s0");
      tr.appendChild(th);
    });

    thead.appendChild(tr);
    this._table.appendChild(thead);
    let tbody = document.createElement('tbody');
    tbody.id = this._bodyId;
    tbody.appendChild(this._createTitle(this._title, this._cols, this._name)); 
    //tbody.appendChild(this._createTitle())           /** We don't need two lines now but we need to have ability */
    tbody.appendChild(this._createHeader(this._labels, this._classes));           
    this._table.appendChild(tbody);
  
    let tableDiv = document.getElementById(this._tableDivId);
    let innerDiv = document.createElement('div');
    innerDiv.id = this._innerDivId;
    innerDiv.appendChild(this._table);
    tableDiv.appendChild(innerDiv);
  }

  /**
   * Create the header element
   * 
   */
  _createHeader(labels, classes) {
    /*
    let arrayIdx = 0;
    if (type=="pointsboard") {
      arrayIdx = 1;
    } 
    */
    //let labels  = [["Pos", "Name", "Round 1", "Round 2", "Round 3", "Round 4", "Total", "+/-"],
    //             ["", "Rank", "Name", "Points", "Events", "# Wins", "Top Three"]];
    //let classes = [["s2", "s2", "s3", "s3", "s3", "s3", "s3", "s3"],
    //             ["p2", "p1", "p1", "p1", "p1", "p1", "p1"]];


    let tr = document.createElement('tr');
    tr.style.height = "20px";
    let th = this._createRowTh();
    tr.appendChild(th);
    // Add the labels
    [...Array(labels.length).keys()].forEach( (n,i) => {
      tr.appendChild(this._createHeaderTd(classes[n], labels[n]))
    });
    return tr;
  }

  /**
   * Create the title of the table
   */
  _createTitle(title, cols, name) {
    let titleId = `${name}TitleLine1`;
    let blankColClass = "s1";
    let titleClass = "s1";
    let colSpan = cols;

    let tr = document.createElement('tr');
    tr.style.height = "20px";
    let th = this._createRowTh(); 
    tr.appendChild(th);
    let td = document.createElement('td');
    td.classList.add(blankColClass);
    tr.appendChild(td);
    td = document.createElement('td');
    td.id = titleId;
    td.classList.add(titleClass);
    td.colSpan = colSpan;
    td.innerHTML = title;
  
    tr.appendChild(td);
  return tr;
  }

  /**
   * Create the body and add the data
   */
  _createBody() {

  }

  /**
   * Create the footer
   */
  _createFooter() {

  }

  /**
   * Create a blank row in the table
   */
  _createBlankRow(){

  }

  /**
   * Create elements for table row
   */
  _createTr() {
    let tr = document.createElement('tr');
    tr.style.height = "20px";
    let th = document.createElement('th');
    th.classList.add("row-headers-background");
    th.style.height = "20px";
    let div = document.createElement('div');
    div.style.height = "20px";
    div.classList.add("row-header-wrapper");
    th.appendChild(div);
    tr.appendChild(th);
    return tr;
  }

  /**
   * Create the row for the table header.
   * 
   * @return {element} Return the th element created with default parms
   */
  _createRowTh() {
    let th = document.createElement('th');
    th.style.height = "20px";
    th.classList.add("row-header-background");
    let div = document.createElement('div');
    div.style.lineHeight = "20px";
    div.classList.add("row-header-wrapper");
    th.appendChild(div);
    return th;
  }

  /**
   * Create table header td element
   */
  _createHeaderTd(headClass, label) {
    let td = document.createElement('td');
    if (headClass != "") {
      td.classList.add(headClass);
    }
    td.innerHTML = label;
    return td;
  }

  /**
   * Load up the table body with the data 
   */
  loadData(data) {
    const evenRowClasses = ["p3", "p2", "p2"]; // White
    const oddRowClasses =  ["p5", "p4", "p4"]; // light blue
    //let table = document.getElementById("statsbody");
    let row;
    let td;

    [...data.statsData].forEach((r,i) => {
      // Create a blank column (previous code)
      row = this._createTr(); 
      /*
      td = document.createElement('tr');
      td.classList.add('p0');
      row.appendChild(td);
      */

      // Loop for each item in the row
      r.forEach((c,j) => {
        td = document.createElement('td');
        if (i%2 == 0) {
          td.classList.add(evenRowClasses[j]);
        } else {
          td.classList.add(oddRowClasses[j]);
        }
        td.innerHTML = c;
        row.appendChild(td);
      });
      this._table.appendChild(row);
    });
  }
}

/**
 * This loads the image from Drive via apps script function
 * background-image: url(http://drive.google.com/uc?export=view&id=1rMWsn5-6VXxUzYtu7XbK3u7e6ODAuTcC)
 * 
 * TPC Scottsdale
 * https://drive.google.com/file/d/1__dNiEx3vdPH_SHQJw9igHyYJWY2iLt0/view?usp=sharing
 */
/*
google.script.run
  .withSuccessHandler( function(bytes){ showImage(bytes) })
  .loadImageBytes();

// Load the image bytes to the DOM img element
function showImage(bytes){
  document.getElementById("banner").src = "data:image/png;base64," + bytes; 
}
*/
/**
 * Request the data from the server 
 * 
 * @param  {object} options object with the request and data for the server side
 * @return {object} Returned data from the server 
 */
async function loadData(options) {
  const e = await new Promise(r => {
    google.script.run.withSuccessHandler(r).getData(options);
  });
  const results = updateTable(e);
}

/**
 * Called when dropdown is used to select a new tournament leaderboard to show
 * 
 * @param {string} The selected option from the dropdown tournament selection list 
 */
function tournySelect(sel) {
  // Build the request object
  let request = {"request":"leaderboard", "number": sel};

  // Reset the tournament selection to the "Select tournament" option
  document.getElementById("tournaments").selectedIndex = 0;

  // Show loading screen 
  show("loading");

  // Request the data from server
  loadData(request);
}

/**
 *  Called when the point board button is pressed
 */
function pointsSelect() {
  // Build the request object
  let request = {"request":"pointsboard"};

  // Reset the tournament selection to the "Select tournament" option
  document.getElementById("tournaments").selectedIndex = 0;

  // Show loading screen
  show("loading");

  // Request the data from the server
  loadData(request);
}

/**
 *  Called when a menu button is pressed
 */
function buttonSelect(option) {
  const validOptions = ["pointsboard","stats"];
  let selectedOption = validOptions.indexOf(option);
  if (selectedOption > 0) {
    /** Build the request object */
    let request = {"request":validOptions[selectedOption]};

    /** Show loading screen */
    show("loading");

    /** Request the data from the server */
    loadData(request);
  }
}

/**
 * Update the table with the data from the spreadsheet
 * 
 * @param {object} data is an object that contains the data as specified in the "request"
 *                 key in the object, which is passed back with the data as 
 *                 "options" key. Data returned will be different based on the request.
 *         
 *                 - "leaderboard" - "data" - contains the table data
 *                                   "courseData" - course data for this tournament
 *                                   "tournyData" - contains the data for the tournament
 *                 - "pointsboard" - "data" - contains the table data
 *                 - "stats"       - "data" - contains the stats based on query key
 *                                   "player" - Player to return the stats for
 *                                      or
 *                                   "course" - Course to return data for
 */
function updateTable(data) {
  console.log(data);
  // Check the request 
  switch(data.options.request) {
    case 'leaderboard':
      buildLeaderboard(data);
      break;
    case 'pointsboard':
      buildPointsboard(data);
      break;
    case 'stats':
      buildStatsPage(data);
      break;
    default:
      console.log(`Request not found: data.options.request = ${data.options.request} `);
  }
}

/**
 * Build the points leaderboard
 * 
 * @param {object} data object with the point leaderboard table data
 */
function buildPointsboard(data) {
  // Get the div for the table and make sure we remove any children to recreate the table
  let pointsDiv = document.getElementById("pointsDiv");
  let pointsInnerDiv = document.getElementById("pointsInnerDiv");
  if (pointsInnerDiv) {
    let plbtable = document.getElementById("pointsInnerDiv");
    pointsDiv.removeChild(plbtable);
  }

  // Create the table for adding the data
  createTable("pointsboard");

  // Now load up the data
  loadPointsData(data);

  // Show the screen
  show("pointsboard");
}

/**
 * Load the data for the points board
 * 
 * @param {object} Object containing the data to build the points board 
 */
function loadPointsData(data) {
  const evenRowClasses = ["p2", "p3", "p2", "p2", "p2", "p2", "p2"]; // White
  const oddRowClasses =  ["p4", "p5", "p4", "p4", "p4", "p4", "p4"]; // light blue
  let table = document.getElementById("plbbody");

  [...data.pointsData].forEach((r,i) => {
    // Create a blank column
    row = createTr();
    td = document.createElement('tr');
    td.classList.add('p0');
    row.appendChild(td);

    // Loop for each item in the row
    r.forEach((c,j) => {
      td = document.createElement('td');
      if (i%2 == 0) {
        td.classList.add(evenRowClasses[j]);
      } else {
        td.classList.add(oddRowClasses[j]);
      }
      td.innerHTML = c;
      row.appendChild(td);
    });
    table.appendChild(row);
  });

  // Add the tourny dates to the title
  document.getElementById("pointsDates").innerHTML = `Through ${data.pointsEvents} events`;

  // Add the info paragraph to explain how it all goes down
  addPointsDescription();
}

/**
 * Add in a paragraph on how the points work
 */
function addPointsDescription() {
  const pointsDiv = document.getElementById("pointsInnerDiv");
  let descriptionText = `<p class="description">Points are awarded by the position you finished in each tournament. 
    You must complete all four rounds to be eligible to collect any points. Points are awarded as follows:</p>
    <ol><li>8 points for 1st</li><li>6 points for 2nd</li><li>4 points for 3rd place</li><li>1 point for completing all rounds 
    (and not finishing top three)</li></ol>
    <p class="description">In the event of ties, each player will receive the points for the position they tied for.</p>`;
  let descriptionDiv = document.createElement("div");
  descriptionDiv.innerHTML = descriptionText;
  pointsDiv.appendChild(descriptionDiv);
}

/**
 * Build the leaderboard based on the data received from the request.
 * 
 * @param {object} Data - object that contain the 2d arrays for the leaderboard
 *                        data - 2d array for the leaderboard
 *                        courseData - 2d array for the course data
 *                        tournyData - 2d array with the relavent tournament data
 */
function buildLeaderboard(data) {  
  // Load up the tournaments that can be selected
  loadTournySelection(data.tournyData.nameValues);

  // Get the div for the table and make sure we remove any children to recreate the table
  let tableDiv = document.getElementById("tableDiv");
  let innerDiv = document.getElementById("innerDiv");
  if (innerDiv) {
    let lbtable = document.getElementById("innerDiv");
    tableDiv.removeChild(lbtable);
  }

  // Create the table for adding the data
  createTable("leaderboard");

  // Load up the table with the returned data
  loadTableData(data);

  // Show the leaderboard
  show('leaderboard');
}

/**
 * Load the data in the leaderboard table, creating elements as needed
 */
function loadTableData(data){
  let tableData = data.data;
  let courseData = data.courseData;
  //let courseData = formatCourseData(data.courseData);
  let tournyData = data.tournyData
  let requestObj = data.options;

  const evenRowClasses = [ ["s4", "s6", "s6", "s6", "s7r", "s5", "s6"], // below par - red
                           ["s4", "s5", "s5", "s5", "s7b", "s5", "s5"]  // above par - black 
                           ]; // White
  const oddRowClasses =  [ ["s8", "s10r", "s10r", "s10r", "s11yr", "s10b", "s10r"],  
                           ["s8", "s10b", "s10b", "s10b", "s11yb", "s10b", "s10b"] 
                           ]; // light yellow
  let bottomEvenRowClasses = [ ["s13wb-r", "s13wr", "s13wr", "s13wr", "s15yb", "s13wb", "s13wr"], // red
                               ["s13wb-r", "s13wb", "s13wb", "s13wb", "s15wb", "s13wb", "s13wb"] // black 
                               ]; // white
  let bottomOddRowClasses = [ ["s2ybbb", "s13r", "s13r", "s13r", "s15yr", "s13r", "s13r"], // red
                              ["s2ybbb", "s13b", "s13b", "s13b", "s15yb", "s13b",  "s13b"]  // black 
                              ]; // yellow
  let courseClasses = ["s16", "s5", "s5", "s5", "s7b", "s4", "s0"];
  const playerIds = [
    "playerName", "playerScore1", "playerScore2", "playerScore3", "playerScore4", "playerTotal", "playerScoreToPar"];

  let row;
  let td;
  let parIndex = 1;
  let red = 0;
  let black = 1;
  let scoreToParCol = 6;
  //let firstScoreCol = 2;
  //let scoreTemplate = `${plusMinus}${toPar} (${c})`;
  let classSelect = black;
  let table = document.getElementById("lbbody");
  let limit = tableData.length;
  let lastCourseSetting = "";

  /**
   *  Loop for all of the table data and course data. add TD elements to TR elements
   */
  [...tableData, ...courseData].forEach((r,i) => {
    /** 
     * Create a Column for player position
     */
    row = createTr();
    td = document.createElement('td');
    if (i<limit) {
      i%2==0 ? td.classList.add('s4') : td.classList.add('s8');
      td.innerHTML = i+1;
      // Bottom row of player data gets a bottom border
      if (i==limit-1) {
        i%2==0 ? td.classList.add('s13wb-r') : td.classList.add('s2ybbb');
      }
    } else {
      td.classList.add('s0');
    }
    row.appendChild(td);

    /** 
     * Now loop for all the data records
     */
    r.forEach((c,j) => {
      td = document.createElement('td');

      /**
       * Below we are still working on the player data rows
       */ 
      if (i < limit) { 
        // Check the each player score to par to pick the correct class
        if ((j>0 && j<5) || j==scoreToParCol) {
          if (c != 0) {
            if (j==scoreToParCol) {
              parseInt(c) < 0 ? classSelect = red : classSelect = black;
            } else {
              parseInt(c) < parseInt(courseData[parIndex][j]) ? 
                classSelect = red : 
                classSelect = black;
            }
          } else {
            classSelect = black;
          }
        } 
        // Even/odd row with correct class
        if (i%2 == 0) {
          if (i==limit-1) {
            td.classList.add(bottomEvenRowClasses[classSelect][j]);
          } else {
            td.classList.add(evenRowClasses[classSelect][j]);
          }
        } else {
          if (i==limit-1) {
            td.classList.add(bottomOddRowClasses[classSelect][j]);
          } else {
            td.classList.add(oddRowClasses[classSelect][j]);
          }
        }
        td.id = playerIds[j];

        // Clear out the 0 scores...
        c==0 ? c="" : c=c;

        /**
         *  Add parens for score to par
         */
        if (j==scoreToParCol) {
          c>0 ? c = `(+${c})` : c=`(${c})`;
          c==`()` ? c = `E` : c=c;
        } 

        /** 
         * Add +/- for each player score
         */
        if (j>0 && j<5 && c!=0) {
          let tmp;
          parseInt(c) < parseInt(courseData[parIndex][j]) ? 
          tmp =`-${parseInt(courseData[parIndex][j])-parseInt(c)} (${c})` : 
          tmp =`+${parseInt(c)-parseInt(courseData[parIndex][j])} (${c})`;
          if (parseInt(c) == parseInt(courseData[parIndex][j])) tmp = `E (${c})`;
          c = tmp;
        }

      /**
       * Above the limit, working on Course records now
       */
      } else {
        td.classList.add(courseClasses[j]); 
      }

      td.innerHTML = c;
      row.appendChild(td);
    });
    table.appendChild(row);
  });

  // Add the tourny name to the title
  let titleElem = document.getElementById("tournyName").innerHTML = data.tournyData.name;

  // Add the tourny dates to the title
  let tournyDateElem = document.getElementById("tournyDates").innerHTML = data.tournyData.tournyDates;

  // Add the last updated to the bottom of the table
  let lastUp = createLastUpdated(data.tournyData.lastUpdate);
  table.appendChild(lastUp);
}

/**
 * Build the stats page
 * 
 * @param {object} data object with the stats data
 */
function buildStatsPage(data) {
  // Get the div for the table and make sure we remove any children to recreate the table
  let statsDiv = document.getElementById("statsDiv");
  let statsInnerDiv = document.getElementById("statsInnerDiv");
  if (statsInnerDiv) {
    let statstable = document.getElementById("statsInnerDiv");
    statsDiv.removeChild(statstable);
  }

  // Create the table for adding the data
  //createTable("statsPage");
  let options = {
    "name": "stats",
    "cols": 3,
    "colWidths": ["180px", "100px", "113px"],
    "title": "Courses Played",
    "labels": ["Course", "Times Played", "Last Played"],
    "classes": ["p3", "p2", "p2"]
    };
  let statsTable = new Table(options, data, statsInnerDiv);

  // Now load up the data
  statsTable.loadData(data);

  // Show the screen
  show("statspage");
}

/**
 * Create the table elements up to where the table contents (scores and course data)
 * 
 * @param {string} type - the type of table to build - leaderboard or pointsboard
 * @return {Element} Return the table element for the leaderboard table
 */
function createTable(type) {
  let tableId = "lbtable";
  let tableDivId = "tableDiv";
  let bodyId = "lbbody";
  let stylesIdx = 0;
  let cols = 8;
  let innerDivId = "innerDiv";
  if (type == "pointsboard") {
    tableId = "plbtable";
    bodyId = "plbbody";
    innerDivId = "pointsInnerDiv";
    tableDivId = "pointsDiv";
    stylesIdx = 1;
    cols = 7;
  }
  // These will define the widths of the columns in the table
  let thStyles = [["30px", "240px", "103px", "103px", "103px", "103px", "37px", "43px"],
                  ["0px", "100px", "236px", "50px", "50px", "50px", "80px"]];
  let table = document.createElement('table');
  table.id = tableId;
  table.classList.add("waffle");
  table.classList.add("no-grid");
  table.cellSpacing = "0";
  table.cellPadding = "0";

  // Create the header elements
  let thead = document.createElement('thead');
  let tr = document.createElement('tr');
  let th = document.createElement('th');
  th.classList.add("row-headers-background");
  tr.appendChild(th);

  [...Array(cols).keys()].forEach(i => {
    th = document.createElement('th');
    th.style.width = `${thStyles[stylesIdx][i]}`;
    th.classList.add("s0");
    tr.appendChild(th);
  });
  thead.appendChild(tr);
  table.appendChild(thead);
  let tbody = document.createElement('tbody');
  tbody.id = bodyId;

  //tbody.appendChild(createBlankRow());
  tbody.appendChild(createTitle(type));
  tbody.appendChild(createDateTitle(type))
  tbody.appendChild(createHeader(type));
  table.appendChild(tbody);
  
  let tableDiv = document.getElementById(tableDivId);
  let innerDiv = document.createElement('div');
  innerDiv.id = innerDivId;
  innerDiv.appendChild(table);
  tableDiv.appendChild(innerDiv);
}

/**
 * Create a blank row in the table
 * 
 * @return {Element} Element to attach to the tbody
 */
function createBlankRow() {
  let tr = document.createElement('tr');
  tr.style.height = "20px";
  let th = createRowTh();
  let td;
  [...Array(8).keys()].forEach(i => {
    td = document.createElement('td');
    td.classList.add("s0");
    tr.appendChild(td);
  });
  return tr;
}

/**
 * Create the header row with the labels in it
 */
function createHeader(type) {
  let arrayIdx = 0;
  if (type=="pointsboard") {
    arrayIdx = 1;
  } 

  let labels  = [["Pos", "Name", "Round 1", "Round 2", "Round 3", "Round 4", "Total", "+/-"],
                 ["", "Rank", "Name", "Points", "Events", "# Wins", "Top Three"]];
  let classes = [["s2", "s2", "s3", "s3", "s3", "s3", "s3", "s3"],
                 ["p2", "p1", "p1", "p1", "p1", "p1", "p1"]];
  let tr = document.createElement('tr');
  tr.style.height = "20px";
  let th = createRowTh();
  tr.appendChild(th);
  // Add the labels
  [...Array(labels[arrayIdx].length).keys()].forEach( (n,i) => {
    tr.appendChild(createHeaderTd(classes[arrayIdx][n], labels[arrayIdx][n]))
  });
  return tr;
}

/**
 * Create the header for the table
 * 
 * @return {Element} tr element with the header
 */
function createTitle(type, text) {
  let title = "Generated Golf+ Leaderboard";
  let titleId = "tournyName";
  let blankColClass = "s1";
  let titleClass = "s1";
  let colSpan = "7";
  if (type=="pointsboard") {
    title = "Golf+ Fun Tournaments Points Leaderboard";
    titleId = "pointsName";
    titleClass = "p0";
    blankColClass = "p2";
    colSpan = "6";
  }
  let tr = document.createElement('tr');
  tr.style.height = "20px";
  let th = createRowTh();
  tr.appendChild(th);
  let td = document.createElement('td');
  td.classList.add(blankColClass);
  tr.appendChild(td);
  td = document.createElement('td');
  td.id = titleId;
  td.classList.add(titleClass);
  td.colSpan = colSpan;
  td.innerHTML = title;
  
  tr.appendChild(td);
  return tr;
}

/**
 * Create the header for the table
 * 
 * @return {Element} tr element with the header
 */
function createDateTitle(type, text) {
  let title = text;
  let titleId = "tournyDates";
  let blankColClass = "s1";
  let titleClass = "s1s";
  let colSpan = "7";
  if (type=="pointsboard") {
    title = "";
    titleId = "pointsDates";
    titleClass = "p0s";
    blankColClass = "p2";
    colSpan = "6";
  }
  let tr = document.createElement('tr');
  tr.style.height = "20px";
  let th = createRowTh();
  tr.appendChild(th);
  let td = document.createElement('td');
  td.classList.add(blankColClass);
  tr.appendChild(td);
  td = document.createElement('td');
  td.id = titleId;
  td.classList.add(titleClass);
  td.colSpan = colSpan;
  td.innerHTML = title;
  
  tr.appendChild(td);
  return tr;
}


/**
 * Create the last updated label for the table
 * 
 * @param  {number} Date in milliseconds
 * @return {Element} tr element with the label
 */
function createLastUpdated(date) {
  let tr = document.createElement('tr');
  tr.style.height = "20px";
  let th = createRowTh();
  tr.appendChild(th);
  let td = document.createElement('td');
  td.classList.add("s8lu");
  tr.appendChild(td);
  td = document.createElement('td');
  td.id = "lastUpdated";
  td.classList.add("s8lu");
  td.colSpan = "7";
  td.style.textAlign = "left";
  td.innerHTML = `Last Updated: ${new Date(date).toLocaleString('en-US')}`;
  tr.appendChild(td);
  return tr;
}

/**
 * Function to add the labels for each column
 */
function createHeaderTd(headClass, label) {
  let td = document.createElement('td');
  if (headClass != "") {
    td.classList.add(headClass);
  }
  td.innerHTML = label;
  return td;
}

/**
 * Create the th for a table row (they are all the same...)
 */
function createRowTh() {
  let th = document.createElement('th');
  th.style.height = "20px";
  th.classList.add("row-header-background");
  let div = document.createElement('div');
  div.style.lineHeight = "20px";
  div.classList.add("row-header-wrapper");
  th.appendChild(div);
  return th;
}

/**
 * Create the table row (tr) and header (th) components to add the table data (td) for 
 * each players scores.
 * 
 * @return {Element} Element to add the td as children to this table row.
 */
function createTr() {
  let tr = document.createElement('tr');
  tr.style.height = "20px";
  let th = document.createElement('th');
  th.classList.add("row-headers-background");
  th.style.height = "20px";
  let div = document.createElement('div');
  div.style.height = "20px";
  div.classList.add("row-header-wrapper");
  th.appendChild(div);
  tr.appendChild(th);
  return tr;
}

/**
 * Load up the tournament names and values for leaderboard selection
 */
function loadTournySelection(data) {
  let selectElem = document.getElementById("tournaments");

  // First check that if we qlready added them
  if (selectElem.hasChildNodes()) {
    let children = selectElem.childNodes;
    // Should have one option and two text nodes to start
    if (children.length < 4) { 
      let optionElem;
      data.forEach(t => {
        optionElem = document.createElement('option');
        optionElem.value = t[0];
        optionElem.innerHTML = t[1];
        selectElem.appendChild(optionElem);
      });
    }
  }
}

/**
 * Format the courses data by adding in the correct icon for each setting
 * 
 * @param {array} courseData course data to format
 */
function formatCourseData(courseData) {
  const titles = ["Tees", "Pins", "Wind", "Green Speed"];
  const teeLocation = {
    "Front":`<svg width="8" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 27">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M.36 0c3.67.53 7.4.53 11.08 0v1.88L8.86 4.65a4.7 4.7 0 0 0-1.26 3.6H4.2a5.4 5.4 0 0 0-1.38-3.6A93.1 93.1 0 0 1 .36 1.88V0Z" fill="#C44242"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M4.2 7.6h3.4v14.2l-1.7 4.8-1.7-4.8V7.6Z" fill="#C44242"></path>
    </svg>`,
    "Middle":`<svg width="8" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 27">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M.36 0c3.67.53 7.4.53 11.08 0v1.88L8.86 4.65a4.7 4.7 0 0 0-1.26 3.6H4.2a5.4 5.4 0 0 0-1.38-3.6A93.1 93.1 0 0 1 .36 1.88V0Z" fill="white"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M4.2 7.6h3.4v14.2l-1.7 4.8-1.7-4.8V7.6Z" fill="white"></path>
    </svg>`,
    "Back": `<svg width="8" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 27">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M.36 0c3.67.53 7.4.53 11.08 0v1.88L8.86 4.65a4.7 4.7 0 0 0-1.26 3.6H4.2a5.4 5.4 0 0 0-1.38-3.6A93.1 93.1 0 0 1 .36 1.88V0Z" fill="black"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M4.2 7.6h3.4v14.2l-1.7 4.8-1.7-4.8V7.6Z" fill="black"></path>
    </svg>`
    }
      const pinLocation = {
      "Easy": `<svg width="13" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 27">
        <path d="M0 5.22 10.92 0v23.95h2.73v-2.3c2.44.46 4.09 1.31 4.09 2.3 0 1.47-3.66 2.66-8.19 2.66-4.52 0-8.19-1.2-8.19-2.66 0-1.32 2.96-2.41 6.83-2.62V9.29L0 5.22Z" fill="#C44242"></path>
    </svg>`,
      "Medium": `<svg width="13" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 27">
        <path d="M0 5.22 10.92 0v23.95h2.73v-2.3c2.44.46 4.09 1.31 4.09 2.3 0 1.47-3.66 2.66-8.19 2.66-4.52 0-8.19-1.2-8.19-2.66 0-1.32 2.96-2.41 6.83-2.62V9.29L0 5.22Z" fill="blue"></path>
    </svg>`,
      "Hard": `<svg width="13" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 27">
        <path d="M0 5.22 10.92 0v23.95h2.73v-2.3c2.44.46 4.09 1.31 4.09 2.3 0 1.47-3.66 2.66-8.19 2.66-4.52 0-8.19-1.2-8.19-2.66 0-1.32 2.96-2.41 6.83-2.62V9.29L0 5.22Z" fill="black"></path>
    </svg>`
    };
    const windSpeed = {
      "Low":` <svg width="13" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 27">
        <path d="M0 5.22 10.92 0v23.95h2.73v-2.3c2.44.46 4.09 1.31 4.09 2.3 0 1.47-3.66 2.66-8.19 2.66-4.52 0-8.19-1.2-8.19-2.66 0-1.32 2.96-2.41 6.83-2.62V9.29L0 5.22Z" fill="#C44242"></path>
    </svg>`,
      "Moderate": `<svg width="18" height="10" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 66 38">
        <path fill-rule="evenodd" clip-rule="evenodd" d="m3.8 8.63-2.35-2.6a3.5 3.5 0 0 0 4.67 5.21h.01v-.01M3.8 8.63l2.35 2.6m-2.35-2.6-2.34-2.6.01-.01.02-.02a7.74 7.74 0 0 1 .74-.6 26.3 26.3 0 0 1 8.8-4.21c6.03-1.6 14.3-1.5 23.74 4.43 7.7 4.84 13.96 4.72 18.22 3.6a19.33 19.33 0 0 0 6.35-3.02 8.6 8.6 0 0 0 .34-.27l-.01.01h.01a3.5 3.5 0 0 1 4.67 5.2l-2.32-2.57 2.32 2.58h-.01l-.02.02a5.82 5.82 0 0 1-.21.18c-.13.11-.3.26-.53.43a26.33 26.33 0 0 1-8.8 4.21c-6.03 1.59-14.3 1.49-23.74-4.44-7.7-4.84-13.97-4.72-18.21-3.6a19.3 19.3 0 0 0-6.36 3.02 8.51 8.51 0 0 0-.34.27m53.54-5.3L62 8.55l-2.34-2.6ZM3.8 29.62l-2.35-2.6a3.5 3.5 0 0 0 4.67 5.21h.01v-.01m-2.34-2.6 2.35 2.6m-2.35-2.6-2.34-2.6.01-.01.02-.02a10.44 10.44 0 0 1 .74-.6 26.31 26.31 0 0 1 8.8-4.21c6.03-1.6 14.3-1.5 23.74 4.44 7.7 4.83 13.96 4.71 18.22 3.59a19.32 19.32 0 0 0 6.35-3.02l.3-.22.04-.05-.01.01h.01a3.5 3.5 0 0 1 4.67 5.2l-2.32-2.56 2.32 2.57-.01.01-.02.02a5.82 5.82 0 0 1-.21.18l-.53.42a26.33 26.33 0 0 1-8.8 4.21c-6.03 1.59-14.3 1.49-23.74-4.44-7.7-4.84-13.97-4.72-18.21-3.6a19.3 19.3 0 0 0-6.36 3.02 8.38 8.38 0 0 0-.34.27m53.54-5.3 2.34 2.6-2.34-2.6Z" fill="white"></path>
    </svg>`,
      "High": `<svg width="18" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 26">
        <path d="M1.6 13.32c3.35-3.03 7.42-3.03 12.2-.02 4.79 3.02 8.85 3.02 12.2-.01M1.6 4.5c3.35-3.04 7.42-3.04 12.2-.02 4.79 3.01 8.85 3 12.2-.02M1.6 22.15c3.35-3.03 7.42-3.04 12.2-.02 4.79 3.02 8.85 3.01 12.2-.02" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path>
    </svg>`
    };
    const greenSpeed = {
      "Fast":`<svg width="35" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 26">
        <path d="M7 17c0-1.1.9-2 2-2h9a2 2 0 1 1 0 4H9a2 2 0 0 1-2-2Z" fill="#fff"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M35 26a13 13 0 1 0 0-26 13 13 0 0 0 0 26Zm2.9-8.6c-.3 0-.5 0-.8.2-1.1.6-1.6 2-1 3a2.2 2.2 0 0 0 3.7.6c-1 .1-1.8-.4-2.3-1.2-.4-1-.2-2 .4-2.6Zm-4-6.4c-.3 0-.5.2-.8.4-1 1-1.2 2.5-.3 3.6a2.4 2.4 0 0 0 4-.4c-.9.3-2 0-2.6-.8-.7-.8-.8-2-.3-2.8Zm-2.5 7.2c-.3 0-.5.2-.8.3-1 .7-1.3 2.2-.6 3.2a2.2 2.2 0 0 0 3.7 0c-.8.3-1.8 0-2.3-.9-.6-.8-.5-1.8 0-2.6Zm-4.8-9.6.6-.5c-.3.9 0 1.9.7 2.5.8.6 1.8.7 2.6.2l-.4.7c-.8 1-2.2 1.2-3.2.4-1-.8-1.1-2.3-.3-3.3Zm-.6 5.2-.7.5c-.8 1-.8 2.4.2 3.3a2.2 2.2 0 0 0 3.6-.9c-.8.4-1.8.3-2.6-.3-.7-.7-.9-1.7-.5-2.6Z" fill="#fff"></path>
        <path d="M0 24c0 1.1.9 2 2 2h23.5c-1.5-.5-2-1-3-2-.6-.6-1.5-2-1.5-2H2a2 2 0 0 0-2 2ZM14 10c0-1.1.9-2 2-2h2a2 2 0 1 1 0 4h-2a2 2 0 0 1-2-2ZM3 10c0-1.1.8-2 1.8-2h5.4c1 0 1.8.9 1.8 2s-.8 2-1.8 2H4.8c-1 0-1.8-.9-1.8-2Z" fill="#fff"></path>
    </svg>`,
      "Pro":`<svg width="35" height="20" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 49 29">
        <path fill-rule="evenodd" clip-rule="evenodd" d="m7.9 2 .1.3L8 2Zm23.7-.8C26.8-1 22.8.2 17.1 2l-1 .4c-6.1 1.8-7.7.6-8 0 3.1 7 9.5 4.6 9.5 4.6S16 10 13 11C6.4 12.9 0 9.2 0 9.2s.7 5.1 4.4 8.3c3.8 3.2 10.8 2 10.8 2s-2 .6-4.6 2c-3.1 1.6-4.9 5.4-4.9 5.4S9.6 24 14.3 25c3 .5 4 1 5.7 1.6l3.7 1.4c3.3 1 8.3.9 8.3.9s-1.8-.2-2.9-.6a8.7 8.7 0 0 1-3.5-2c-1.2-1-2.4-2.8-3.7-4-2.5-2-5-1.4-6.5-.6 2.3-2.8 4.6-4.6 6.2-5.5-6.4 3.2-11.7 0-13.6-2.2.8.8 4.8 2 9.8-3L19 10c4.1-4.1 8-8.4 12.5-8.7Z" fill="#fff"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M36 28a13 13 0 1 0 0-26 13 13 0 0 0 0 26Zm2.9-8.6c-.3 0-.5 0-.8.2-1.1.6-1.6 2-1 3a2.2 2.2 0 0 0 3.7.6c-1 .1-1.8-.4-2.3-1.2-.4-1-.2-2 .4-2.6Zm-4-6.4c-.3 0-.5.2-.8.4-1 1-1.2 2.5-.3 3.6a2.4 2.4 0 0 0 4-.4c-.9.3-2 0-2.6-.8-.7-.8-.8-2-.3-2.8Zm-2.5 7.2c-.3 0-.5.2-.8.3-1 .7-1.3 2.2-.6 3.2a2.2 2.2 0 0 0 3.7 0c-.8.3-1.8 0-2.3-.9-.6-.8-.5-1.8 0-2.6Zm-4.8-9.6.6-.5c-.3.9 0 1.9.7 2.5.8.6 1.8.7 2.6.2l-.4.7c-.8 1-2.2 1.2-3.2.4-1-.8-1.1-2.3-.3-3.3Zm-.6 5.2-.7.5c-.8 1-.8 2.4.2 3.3a2.2 2.2 0 0 0 3.6-.9c-.8.4-1.8.3-2.6-.3-.7-.7-.9-1.7-.5-2.6Z" fill="#fff"></path>
    </svg>`
    };

  //console.log(`${JSON.stringify(courseData)}`);
  //console.log(`(A) svg data "Front" ${teeLocation["Front"]}`);
  //console.log(`(B) svg data "Front" ${teeLocation.Front}`);
  let retData = [];
  let retRec = [];
  courseData.forEach((r,i) => {
    if (titles.includes(r[0])) {
      let loc = "";
      let ary = [];
      switch(r[0]) {
        case "Tees":
          ary = teeLocation;
          break;
        case "Pins":
          ary = pinLocation;
          break;
        case "Wind":
          ary = windSpeed;
          break;
        case "Green Speed":
          ary = greenSpeed;
          break;
        default:
          ary = teeLocation;
          break;
      }

      /**
       * Add the title back in untouched
       */
      retRec.push(r[0]);

      /**
       * Loop through the rest of the options and add the icon
       */
      r.forEach((c,j) => {
        if (j>0) {
          loc = r[j];
          //console.log(`loc=${loc} ary[loc]= ${ary[loc]}`);
          retRec.push(`<div style="display:flex;">${loc} ${ary[loc]}</div>`);
        }
      });
      retData.push(retRec);
      retRec =[];
    } else {
      retData.push(r);
    }
  });

  return retData; //courseData;
}

/**
 * Show a screen, which in our case is hiding all of the other divs and show the one passed
 */
function show(name) {
  let screens = ["loading", "leaderboard", "pointsboard", "statspage"];
  let ids = ["loading", "tableDiv", "pointsDiv", "statsDiv"];
  ids.forEach(e => {
    document.getElementById(e).style.display = "none";
  });
  document.getElementById(ids[screens.indexOf(name)]).style.display = "block";
}

/**
 * GeoLocation wrapped in a async function. After the location is obtained or rejected by the user call the loadData()
 * method with the request object to kick off the first screen.
 */
async function getGeoLocation() {
  let request = {'request':'leaderboard', 'number':'current'};
  let result = {"location": [0, 0], "code":-99, "browserInfo":navigator.userAgent};

  try {
    const position = await getCurrentPosition()
    result.location = [position.coords.latitude, position.coords.longitude];
    result.code = 0;
  } catch(err) {
    console.log(err);
    result.code = -1;
  }

  /** Save the location info, if any, in the request */
  request.userInfo = result;

  /** Now load the data */
  loadData(request);

  function getCurrentPosition() {
    return new Promise( (resolve, reject) => {
      navigator.geolocation.getCurrentPosition(
        position => resolve(position),
          error => reject(error)
      )
    })
  }

  //return result;
}

/**
 * ----------------
 *      Main
 * ----------------
 */
/** Show a loading screen before data is loaded */
show('loading');

/** Get the position of the user and then load data */
getGeoLocation();

</script>
